/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */
 // Based on file provided on canvas

#include <stdio.h>
#include <rpc/rpc.h>
#include <unistd.h>
#include <sys/types.h>
#include <pwd.h>
#include "ssnfs.h"

CLIENT *clnt;

void ssnfsprog_1(char *host)
{
clnt = clnt_create (host, SSNFSPROG, SSNFSVER, "tcp");
	if (clnt == NULL) {
		clnt_pcreateerror (host);
		exit (1);
	}
}

/*
Open: opens a file with the given name in the user's directory. If file does
not exist, it is created. If file cannot be opened or created, return -1 as an
indicator of error.
returns: file descriptor of opened file.
*/
int Open(char *filename_to_open){
	printf("\nIn client: opening %s\n", filename_to_open);
  open_output  *result_1;
  open_input  open_file_1_arg;
  strcpy(open_file_1_arg.user_name, getpwuid(getuid())->pw_name);
  strcpy(open_file_1_arg.file_name,filename_to_open);
  result_1 = open_file_1(&open_file_1_arg, clnt);
	if (result_1 == (open_output *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	//printf ("In client: Directory name is:%s \nIn client: Name of the file opened is:%s \nIn client: file descriptor returned is:%d\n", open_file_1_arg.user_name, result_1->out_msg.out_msg_val,  result_1->fd);
	printf("%s\n", result_1->out_msg.out_msg_val);
	if (result_1->fd > -1) {
		printf("file descriptor returned is:%d\n", result_1->fd);
	}

	return result_1->fd;
}

void Write(int fd, char * buffer, int num_bytes_to_write){
	buffer[num_bytes_to_write-1] = '\0';
	printf("\nIn client: writing \"%s\" (%dB) to fd:%d\n", buffer, num_bytes_to_write, fd);
	write_output *result_3;
	write_input write_file_1_arg;
	char message[num_bytes_to_write];
	memcpy(message, buffer, num_bytes_to_write);
	message[num_bytes_to_write-1] = '\0';
	//printf("full message(%dB): %s", sizeof(message), message);
	write_file_1_arg.fd = fd;
	write_file_1_arg.buffer.buffer_val = malloc(num_bytes_to_write);
	strcpy(write_file_1_arg.user_name, getpwuid(getuid())->pw_name);
	strcpy(write_file_1_arg.buffer.buffer_val, message);
	write_file_1_arg.buffer.buffer_len = num_bytes_to_write;
	write_file_1_arg.numbytes = num_bytes_to_write;
	result_3 = write_file_1(&write_file_1_arg, clnt);
		if (result_3 == (write_output *) NULL) {
			clnt_perror (clnt, "call failed");
		}
	printf("%s\n", result_3->out_msg.out_msg_val);
}

void Read(int fd, char * buffer, int num_bytes_to_read){
	printf("\nIn client: reading %dB from fd: \n", num_bytes_to_read, fd);
  read_output * result_2;
	read_input read_file_1_arg;
	// ask server to read the file I own with a
	read_file_1_arg.fd = fd;
	strcpy(read_file_1_arg.user_name, getpwuid(getuid())->pw_name);
	read_file_1_arg.numbytes = num_bytes_to_read;

	result_2 = read_file_1(&read_file_1_arg, clnt);
	if (result_2 == (read_output *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	//memcpy(buffer, result_2->out_msg.out_msg_val, result_2->out_msg.out_msg_len);
	printf("File contents:\n%s\n+---------------+\n", result_2->out_msg.out_msg_val);
}

void Close(int fd){
	printf("\nIn client: closing fd: %d\n", fd);
	close_output  *result_6;
	close_input  close_file_1_arg;
	close_file_1_arg.fd = fd;
	strcpy(close_file_1_arg.user_name, getpwuid(getuid())->pw_name);
  result_6 = close_file_1(&close_file_1_arg, clnt);
	if (result_6 == (close_output *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("%s", result_6->out_msg.out_msg_val);
}

void List(){
	printf("\nIn client: requesting file list.");
	list_output  *result_4;
	list_input  list_files_1_arg;
	strcpy(list_files_1_arg.user_name, getpwuid(getuid())->pw_name);
	result_4 = list_files_1(&list_files_1_arg, clnt);
	if (result_4 == (list_output *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("files owned by: %s\n%s", list_files_1_arg.user_name, result_4->out_msg.out_msg_val);
}

void Delete(char * filename) {
	printf("\nIn client: delete file %s", filename);
	delete_output  *result_5;
	delete_input  delete_file_1_arg;
	strcpy(delete_file_1_arg.file_name, filename);
	strcpy(delete_file_1_arg.user_name, getpwuid(getuid())->pw_name);
	result_5 = delete_file_1(&delete_file_1_arg, clnt);
	if (result_5 == (delete_output *) NULL) {
		clnt_perror (clnt, "call failed");
	}
	printf("%s", result_5->out_msg.out_msg_val);
}

void OpenTest() {
	// test a long filename
	Open("this_is_a_long_file_name");

	// open a lot of files
	char fname[6] = "file01";
	for (int i = 0; i < 25; i++) {
		sprintf(fname, "file%02d", i);
		Open(fname);
	}
	for (int i = 0; i < 20; i++) {
		sprintf(fname, "file%02d", i);
		Close(i);
	}

	// open same file many times
	for (int i = 0; i < 5; i++) {
		Open("test");
	}
}

void WriteTest() {
	char fname1[7] = "myfile\0";
	int fd1 = Open(fname1);

	// write exactly 1 blocks
	char buffer[512];
	for (int i = 0; i < 512; i++) {
		buffer[i] = 'a'+i%26;
	}
	Write(fd1, buffer, 512);

	Close(fd1);
	fd1 = Open(fname1);
	char result[512];
	Read(fd1, result, 512);

	// write up all of memory
	for (int i = 0; i < 32000; i++) {
		Write(fd1, buffer, 512);
	}

}

int main (int argc, char *argv[])
{
	char *host;

	if (argc < 2) {
		printf ("usage: %s server_host\n", argv[0]);
		exit (1);
	}
	host = argv[1];
	ssnfsprog_1 (host);

	// Test all cases for open
	//OpenTest();
	WriteTest();
	/*
	int fd1 = Open("myfile");

	Write(fd1, "hi this is my file. it only prints half.\n", 20);

	Close(fd1);

	fd1 = Open("myfile");

	char buffer1[20];
	Read(fd1, buffer1, 20);

	List();

	Delete("myfile");

	fd1 = Open("myfile");

	Read(fd1, buffer1, 20);
	*/
	/*
	int fd2 = Open("secret");

	char long_str[1000];
	memset(long_str, 'a', 1000);
	Write(fd2, long_str, 1000);

	char buffer0[1000];
	Read(fd2, buffer0, 1000);

	int fd3 = Open("thirdfile");
	int fd4 = Open("michael");

	List();

	int bytes_to_read = 20;
	char buffer[bytes_to_read];
	Read(fd1, buffer, bytes_to_read);
	printf("Reading fd %d:\n%s", fd1, buffer);

	char buffer2[10];
	Read(10, buffer2, 10);

	List();
*/
exit (0);
}
